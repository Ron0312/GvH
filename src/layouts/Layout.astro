---
import '../styles/global.css';
import Soundscape from '../components/Soundscape';

interface Props {
	title: string;
    description?: string;
    schema?: string; // Optional custom schema prop
}

const { title, description = "Meisterhafte Gartenarchitektur und Speziallösungen für komplexe Hanglagen und exklusive Refugien.", schema } = Astro.props;

// Global Schema (LocalBusiness)
const globalSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "LandscapeArchitect",
  "name": "Gaerten von Hoerschelmann",
  "description": description,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Lademannbogen 41",
    "addressLocality": "Hamburg",
    "postalCode": "22339",
    "addressCountry": "DE"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": "53.6471",
    "longitude": "10.0573"
  },
  "url": "https://gaertenvonhoerschelmann.de",
  "telephone": "+49 40 123456789",
  "founder": {
    "@type": "Person",
    "name": "Sören von Hoerschelmann"
  },
  "image": "https://gaertenvonhoerschelmann.de/img/Wohnen-Garten-Blick-aus-der-Terrassentuer-Rahmen-Parrotie-Eisenholz-Gaerten-des-Jahres-scaled.jpg",
  "priceRange": "$$$",
  "areaServed": ["Hamburg", "Lauenburg", "Sylt", "Kitzbühel"],
  "openingHours": "Mo-Fr 08:00-18:00"
});
---

<!doctype html>
<html lang="de" class="scroll-smooth">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={description} />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />

        <!-- Security Headers (Simulation for meta) -->
        <meta http-equiv="X-XSS-Protection" content="1; mode=block">
        <meta http-equiv="X-Content-Type-Options" content="nosniff">
        <meta name="referrer" content="strict-origin-when-cross-origin">

        <link rel="preconnect" href="https://fonts.bunny.net">
        <link href="https://fonts.bunny.net/css?family=playfair-display:400,400i,700|inter:200,300,400,600,700" rel="stylesheet" />

        <!-- Open Graph Tags -->
        <meta property="og:title" content={title}>
        <meta property="og:description" content={description}>
        <meta property="og:type" content="website">
        <meta property="og:site_name" content="Gaerten von Hoerschelmann">
        <meta name="twitter:card" content="summary_large_image">

        <!-- Structured Data -->
        <script type="application/ld+json" set:html={globalSchema}></script>
        {schema && <script type="application/ld+json" set:html={schema}></script>}

		<title>{title}</title>

        <script>
             // Lenis
            import Lenis from '@studio-freight/lenis'

            const lenis = new Lenis({
                duration: 1.4,
                easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t))
            })

            function raf(time) {
                lenis.raf(time)
                requestAnimationFrame(raf)
            }

            requestAnimationFrame(raf)

            // Custom Cursor with advanced mode
            if (window.matchMedia("(min-width: 1024px)").matches) {
                const cursorDot = document.getElementById('cursor-dot');
                const cursorOutline = document.getElementById('cursor-outline');
                const cursorText = document.getElementById('cursor-text');

                let mouseX = 0, mouseY = 0, dotX = 0, dotY = 0, outX = 0, outY = 0;

                window.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });

                const animateCursor = () => {
                    dotX += (mouseX - dotX) * 0.15;
                    dotY += (mouseY - dotY) * 0.15;
                    outX += (mouseX - outX) * 0.08;
                    outY += (mouseY - outY) * 0.08;

                    if(cursorDot) cursorDot.style.transform = `translate3d(${dotX}px, ${dotY}px, 0) translate(-50%, -50%)`;
                    if(cursorOutline) cursorOutline.style.transform = `translate3d(${outX}px, ${outY}px, 0) translate(-50%, -50%)`;

                    requestAnimationFrame(animateCursor);
                };
                requestAnimationFrame(animateCursor);
            }

            // Global helpers for cursor interaction
            window.setCursorMode = (active, text = "Details") => {
                if(window.innerWidth < 1024) return;
                const out = document.getElementById('cursor-outline');
                const txt = document.getElementById('cursor-text');
                if(out && txt) {
                    if(active) {
                         out.style.width = '70px'; out.style.height = '70px';
                         out.style.background = 'rgba(210, 180, 140, 0.08)';
                         txt.style.opacity = '1';
                         if(text) txt.innerText = text;
                    } else {
                         out.style.width = '40px'; out.style.height = '40px';
                         out.style.background = 'transparent';
                         txt.style.opacity = '0';
                    }
                }
            };

            // Magnetic Element Logic
             const magneticElements = document.querySelectorAll('.magnetic-wrap');
             magneticElements.forEach(el => {
                if (window.innerWidth < 1024) return;
                const strength = 0.3; // Default strength, could be parsed from attribute if needed

                el.addEventListener('mousemove', (e) => {
                    const { clientX, clientY } = e;
                    const { left, top, width, height } = el.getBoundingClientRect();
                    const x = (clientX - (left + width / 2)) * strength;
                    const y = (clientY - (top + height / 2)) * strength;
                    el.style.transform = `translate3d(${x}px, ${y}px, 0)`;
                });

                el.addEventListener('mouseleave', () => {
                     el.style.transform = `translate3d(0, 0, 0)`;
                });
             });


            // Season Switch Logic
            const month = new Date().getMonth(); // 0-11
            const body = document.body;
            // Simple class application for potential CSS hooks
            if (month >= 2 && month <= 4) body.classList.add('season-spring');
            else if (month >= 5 && month <= 7) body.classList.add('season-summer');
            else if (month >= 8 && month <= 10) body.classList.add('season-autumn');
            else body.classList.add('season-winter');

            // Scroll Progress
            const progressBar = document.createElement('div');
            progressBar.classList.add('scroll-progress');
            progressBar.id = 'scrollBar';
            document.body.appendChild(progressBar);

            window.addEventListener('scroll', () => {
                const y = window.scrollY;
                const bar = document.getElementById("scrollBar");
                if(bar) bar.style.width = (y / (document.documentElement.scrollHeight - window.innerHeight)) * 100 + "%";
            });

        </script>
	</head>
	<body class="season-default">
        <!-- Scroll Progress (Added in JS, but also in user HTML as explicit div) -->
        <!-- User HTML has <div class="scroll-progress" id="scrollBar" aria-hidden="true"></div> in body, handled by JS above -->

        <!-- Custom Cursor -->
        <div id="cursor-dot" class="custom-cursor hidden lg:block"></div>
        <div id="cursor-outline" class="custom-cursor-outline hidden lg:block">
            <span id="cursor-text" class="cursor-text">Details</span>
        </div>

        <!-- Loader: User Version -->
        <div id="preloader" class="preloader">
            <div class="loader-logo">Gaerten von Hoerschelmann</div>
            <div class="loader-bar-container">
                <div class="loader-bar-fill"></div>
            </div>
        </div>

        <script is:inline>
            // Immediate check to prevent flash if already visited
            if (sessionStorage.getItem('visited')) {
                const loader = document.getElementById('preloader');
                if (loader) loader.style.display = 'none';
            }
        </script>

        <Soundscape client:idle />

		<slot />

        <script>
            // Preloader logic
            window.addEventListener('load', () => {
                const loader = document.getElementById('preloader');
                if (!sessionStorage.getItem('visited')) {
                    setTimeout(() => {
                        if(loader) loader.classList.add('fade-out');
                        sessionStorage.setItem('visited', 'true');
                    }, 800);
                }
            });

            // Intersection Observer for reveals
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) entry.target.classList.add('active');
                });
            }, { threshold: 0.1 });

            setTimeout(() => {
                document.querySelectorAll('.reveal-obs').forEach(el => observer.observe(el));
            }, 100);
        </script>
	</body>
</html>
