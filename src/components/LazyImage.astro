---
interface Props {
    src: string;
    alt: string;
    className?: string;
    aspect?: string;
    autoColor?: boolean;
    sketch?: string; // Optional: path to sketch image for hover
}

const { src, alt, className = "", aspect = "aspect-square", autoColor = false, sketch } = Astro.props;
---

<div class={`lazy-image-container gallery-border relative overflow-hidden ${aspect} ${className} img-placeholder group`} data-src={src} data-autocolor={autoColor}>
    <img
        src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
        alt={alt}
        class={`w-full h-full object-cover transition-all duration-1000 opacity-0 scale-110 lazy-image will-change-transform group-hover:scale-105`}
        loading="lazy"
    />

    {sketch && (
        <div class="absolute inset-0 z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-700 bg-white/90 flex items-center justify-center pointer-events-none mix-blend-multiply">
            <img src={sketch} alt="Skizze" class="w-full h-full object-contain p-8 scale-105 group-hover:scale-100 transition-transform duration-700" />
            <div class="absolute bottom-4 left-4 text-brand-dark text-[9px] uppercase tracking-widest font-bold">Die Partitur</div>
        </div>
    )}
</div>

<script>
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const container = entry.target as HTMLElement;
                const img = container.querySelector('img.lazy-image') as HTMLImageElement;
                const src = container.getAttribute('data-src');
                const autoColor = container.getAttribute('data-autocolor') === 'true';

                if (img && src) {
                    img.src = src;
                    img.onload = () => {
                        container.classList.remove('img-placeholder');
                        img.classList.remove('opacity-0', 'scale-110');
                        img.classList.add('opacity-100', 'scale-100');

                        if (autoColor) {
                            img.classList.add('animate-color-reveal');
                        }
                    };
                }
                observer.unobserve(container);
            }
        });
    }, { threshold: 0.05 });

    document.querySelectorAll('.lazy-image-container').forEach(el => observer.observe(el));
</script>
